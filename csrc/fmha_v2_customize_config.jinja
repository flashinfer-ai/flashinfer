/*
 * Copyright (c) 2023-2025 by FlashInfer team.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#pragma once

#include <cuda_fp16.h>
#include <cuda_bf16.h>
#include <cuda_fp8.h>
#include <fused_multihead_attention.h>
#include <stdexcept>

//===----------------------------------------------------------------------===//
// FMHAv2 Runtime Dispatch Configuration
// This file provides macros for runtime dispatch over compile-time specialized
// kernel instantiations.
//===----------------------------------------------------------------------===//

// Supported dtypes: {{ supported_dtypes }}
// Supported head_dim_qk: {{ supported_head_dim_qk }}
// Supported head_dim_vo: {{ supported_head_dim_vo }}

//===----------------------------------------------------------------------===//
// DISPATCH_FMHA_V2_DTYPE - Runtime dispatch over data types
//===----------------------------------------------------------------------===//

#define DISPATCH_FMHA_V2_DTYPE(dtype_code, BODY)                                \
  [&]() {                                                                       \
    switch (dtype_code) {                                                       \
{% for dtype_name, dtype_cpp in dtype_mappings %}
      case {{ dtype_name }}: {                                                  \
        using DTypeQ = {{ dtype_cpp }};                                         \
        using DTypeKV = {{ dtype_cpp }};                                        \
        using DTypeO = {{ dtype_cpp }};                                         \
        return BODY();                                                          \
      }                                                                         \
{% endfor %}
      default:                                                                  \
        throw std::runtime_error("Unsupported dtype for FMHAv2");               \
    }                                                                           \
  }()

//===----------------------------------------------------------------------===//
// DISPATCH_FMHA_V2_HEAD_DIM - Runtime dispatch over head dimensions
//===----------------------------------------------------------------------===//

#define DISPATCH_FMHA_V2_HEAD_DIM(head_dim_qk_val, head_dim_vo_val, BODY)       \
  [&]() {                                                                       \
{% for hd_qk, hd_vo in head_dim_combinations %}
{% if loop.first %}
    if (head_dim_qk_val == {{ hd_qk }} && head_dim_vo_val == {{ hd_vo }}) {     \
{% else %}
    } else if (head_dim_qk_val == {{ hd_qk }} && head_dim_vo_val == {{ hd_vo }}) { \
{% endif %}
      constexpr int HEAD_DIM_QK = {{ hd_qk }};                                  \
      constexpr int HEAD_DIM_VO = {{ hd_vo }};                                  \
      return BODY();                                                            \
{% endfor %}
    } else {                                                                    \
      throw std::runtime_error("Unsupported head dimension for FMHAv2");        \
    }                                                                           \
  }()

//===----------------------------------------------------------------------===//
// DISPATCH_context - Combined runtime dispatch
//===----------------------------------------------------------------------===//

#define DISPATCH_context(dtype_code, head_dim_qk_val, head_dim_vo_val, BODY)    \
  DISPATCH_FMHA_V2_DTYPE(dtype_code, [&] {                                      \
    return DISPATCH_FMHA_V2_HEAD_DIM(head_dim_qk_val, head_dim_vo_val, BODY);   \
  })
