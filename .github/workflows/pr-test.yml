# CI Gateway workflow - Creates check runs and triggers test runner
#
# Architecture:
# 1. This workflow (gateway) runs on pull_request/push/workflow_dispatch
# 2. For PRs: Creates custom check runs via GitHub App
# 3. Triggers pr-test-runner.yml to run actual tests
# 4. PR status shows our check runs (not the runner's internal jobs)
#
# This design ensures failed spot attempts don't pollute the PR status.
#
# Permission Control:
# - Push to main: Always runs
# - PR from org members (ci-users team): Runs automatically
# - PR from external contributors: Requires 'run-ci' label
#   (added via @flashinfer-bot run command from authorized user)

name: PR Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:
    inputs:
      skip_aot:
        description: 'Skip AOT build tests'
        type: boolean
        default: false
      skip_gpu:
        description: 'Skip GPU tests'
        type: boolean
        default: false

concurrency:
  group: pr-test-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: write

env:
  EXECUTOR_NUMBER: "0"

jobs:
  # ---------------------------------------------------------------------------
  # Gate - Check if PR is authorized to run CI
  # ---------------------------------------------------------------------------
  gate:
    name: Permission Check
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
    steps:
      - name: Check authorization
        id: check
        env:
          GH_TOKEN: ${{ secrets.FLASHINFER_GITHUB_TOKEN }}
        run: |
          # Always allow push to main and workflow_dispatch
          if [[ "${{ github.event_name }}" != "pull_request" ]]; then
            echo "authorized=true" >> "$GITHUB_OUTPUT"
            echo "Not a PR, authorized"
            exit 0
          fi

          # Check if PR has run-ci label
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'run-ci') }}" == "true" ]]; then
            echo "authorized=true" >> "$GITHUB_OUTPUT"
            echo "PR has run-ci label, authorized"
            exit 0
          fi

          # Check if PR author is a member of ci-users team
          AUTHOR="${{ github.event.pull_request.user.login }}"
          ORG="${{ github.repository_owner }}"
          TEAM="ci-users"

          echo "Checking if $AUTHOR is a member of $ORG/$TEAM..."

          if [[ -z "$GH_TOKEN" ]]; then
            echo "::warning::FLASHINFER_GITHUB_TOKEN not set, falling back to association check"
            # Fallback: check if author has write access
            ASSOC="${{ github.event.pull_request.author_association }}"
            if [[ "$ASSOC" =~ ^(OWNER|MEMBER|COLLABORATOR)$ ]]; then
              echo "authorized=true" >> "$GITHUB_OUTPUT"
              echo "PR author has $ASSOC access, authorized"
            else
              echo "authorized=false" >> "$GITHUB_OUTPUT"
              echo "PR author is $ASSOC, not authorized"
            fi
            exit 0
          fi

          # Check team membership
          MEMBERS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            --paginate \
            "/orgs/${ORG}/teams/${TEAM}/members" \
            --jq '.[].login' 2>&1) || {
            echo "::warning::Failed to get team members: $MEMBERS"
            echo "authorized=false" >> "$GITHUB_OUTPUT"
            exit 0
          }

          if echo "$MEMBERS" | grep -qx "$AUTHOR"; then
            echo "authorized=true" >> "$GITHUB_OUTPUT"
            echo "$AUTHOR is a member of $TEAM, authorized"
          else
            echo "authorized=false" >> "$GITHUB_OUTPUT"
            echo "$AUTHOR is not a member of $TEAM, not authorized"
          fi

  # ---------------------------------------------------------------------------
  # Setup - Read docker tag and check if build should be skipped
  # ---------------------------------------------------------------------------
  setup:
    name: Setup
    needs: gate
    if: needs.gate.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.get-tag.outputs.tag }}
      skip_build: ${{ steps.check.outputs.skip }}
      head_sha: ${{ steps.get-sha.outputs.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get HEAD SHA
        id: get-sha
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Get Docker Tag
        id: get-tag
        run: |
          TAG=$(grep 'flashinfer/flashinfer-ci-cu129:' ci/docker-tags.yml | cut -d':' -f2 | tr -d ' ')
          if [ -z "$TAG" ]; then
            echo "::error::Failed to extract Docker tag from ci/docker-tags.yml"
            exit 1
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Docker tag: $TAG"

      - name: Check Skip Conditions
        id: check
        run: |
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Use PR event SHAs for reliable diff (avoids issues with origin refs)
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          CHANGED=$(git diff --name-only "$BASE_SHA...$HEAD_SHA")
          # TODO (yongwww): Add back ^\.github/ before merging to main
          SKIP_PATTERNS="README.md|^docs/|^docker/|^licenses/|^LICENSE$|^NOTICE$|^version\.txt$"

          SKIP=true
          while IFS= read -r file; do
            if [ -n "$file" ] && ! echo "$file" | grep -qE "$SKIP_PATTERNS"; then
              SKIP=false
              break
            fi
          done <<< "$CHANGED"

          echo "skip=$SKIP" >> $GITHUB_OUTPUT
          if [ "$SKIP" == "true" ]; then
            echo "::notice::Skipping build - only docs/config files changed"
          fi

  # ---------------------------------------------------------------------------
  # Orchestrator - Create check runs and trigger test runner
  # ---------------------------------------------------------------------------
  orchestrator:
    name: Orchestrate Tests
    needs: [gate, setup]
    if: |
      needs.gate.outputs.authorized == 'true' &&
      needs.setup.outputs.skip_build != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.FLASHINFER_CI_APP_ID }}
          private-key: ${{ secrets.FLASHINFER_CI_APP_PRIVATE_KEY }}

      - name: Create Check Runs (PR only)
        id: create-checks
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          SHA="${{ needs.setup.outputs.head_sha }}"
          REPO="${{ github.repository }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "Creating check runs for SHA: $SHA"

          # Create AOT Build check run
          if [ "${{ github.event.inputs.skip_aot }}" != "true" ]; then
            AOT_CHECK=$(gh api repos/$REPO/check-runs \
              -f name="CI: AOT Build Tests" \
              -f head_sha="$SHA" \
              -f status="in_progress" \
              -F output[title]="Running AOT build tests..." \
              -F output[summary]="Tests running on spot instances. [View workflow run]($RUN_URL)" \
              --jq '.id')
            echo "Created AOT check run: $AOT_CHECK"
            echo "aot_check_id=$AOT_CHECK" >> $GITHUB_OUTPUT
          fi

          # Create GPU A10G check run
          if [ "${{ github.event.inputs.skip_gpu }}" != "true" ]; then
            A10G_CHECK=$(gh api repos/$REPO/check-runs \
              -f name="CI: GPU Tests (A10G)" \
              -f head_sha="$SHA" \
              -f status="in_progress" \
              -F output[title]="Running GPU tests on A10G..." \
              -F output[summary]="Tests running on spot instances. [View workflow run]($RUN_URL)" \
              --jq '.id')
            echo "Created GPU A10G check run: $A10G_CHECK"
            echo "gpu_a10g_check_id=$A10G_CHECK" >> $GITHUB_OUTPUT

            # Create GPU T4 check run
            T4_CHECK=$(gh api repos/$REPO/check-runs \
              -f name="CI: GPU Tests (T4)" \
              -f head_sha="$SHA" \
              -f status="in_progress" \
              -F output[title]="Running GPU tests on T4..." \
              -F output[summary]="Tests running on spot instances. [View workflow run]($RUN_URL)" \
              --jq '.id')
            echo "Created GPU T4 check run: $T4_CHECK"
            echo "gpu_t4_check_id=$T4_CHECK" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Test Runner
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          REPO="${{ github.repository }}"
          REF="${{ github.ref }}"

          # For PRs, use the PR head ref; for push/dispatch, use the current ref
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Use the base branch (main) to trigger workflow_dispatch
            # The runner will checkout the PR SHA
            DISPATCH_REF="main"
          else
            DISPATCH_REF="${{ github.ref_name }}"
          fi

          echo "Triggering pr-test-runner.yml on ref: $DISPATCH_REF"

          gh workflow run pr-test-runner.yml \
            --repo "$REPO" \
            --ref "$DISPATCH_REF" \
            -f pr_head_sha="${{ needs.setup.outputs.head_sha }}" \
            -f docker_tag="${{ needs.setup.outputs.docker_tag }}" \
            -f aot_check_id="${{ steps.create-checks.outputs.aot_check_id || '' }}" \
            -f gpu_a10g_check_id="${{ steps.create-checks.outputs.gpu_a10g_check_id || '' }}" \
            -f gpu_t4_check_id="${{ steps.create-checks.outputs.gpu_t4_check_id || '' }}" \
            -f skip_aot="${{ github.event.inputs.skip_aot || 'false' }}" \
            -f skip_gpu="${{ github.event.inputs.skip_gpu || 'false' }}"

          echo "Test runner workflow triggered successfully"

      - name: Summary
        run: |
          echo "## PR Test Gateway" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** ${{ needs.setup.outputs.head_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Tag:** ${{ needs.setup.outputs.docker_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "### Check Runs Created" >> $GITHUB_STEP_SUMMARY
            echo "- AOT Build: ${{ steps.create-checks.outputs.aot_check_id || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
            echo "- GPU A10G: ${{ steps.create-checks.outputs.gpu_a10g_check_id || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
            echo "- GPU T4: ${{ steps.create-checks.outputs.gpu_t4_check_id || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test runner workflow has been triggered." >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Report unauthorized PRs
  # ---------------------------------------------------------------------------
  report-unauthorized:
    name: Report Unauthorized
    needs: gate
    if: github.event_name == 'pull_request' && needs.gate.outputs.authorized != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Post Comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "## CI Authorization Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This PR requires authorization to run CI." >> $GITHUB_STEP_SUMMARY
          echo "A member of @flashinfer-ai/ci-users can comment \`@flashinfer-bot run\` to approve." >> $GITHUB_STEP_SUMMARY
