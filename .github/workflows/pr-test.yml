# CI workflow using AWS self-hosted runners.
# Runs AOT build tests and GPU unit tests on push/PR to main.

name: PR Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_aot:
        description: 'Skip AOT build tests'
        type: boolean
        default: false
      skip_gpu:
        description: 'Skip GPU tests'
        type: boolean
        default: false

concurrency:
  group: pr-test-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  # Jenkins compatibility variables (used by task_show_node_info.sh)
  EXECUTOR_NUMBER: "0"

jobs:
  # ---------------------------------------------------------------------------
  # Setup - Read docker tag and check if build should be skipped
  # ---------------------------------------------------------------------------
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.get-tag.outputs.tag }}
      skip_build: ${{ steps.check.outputs.skip }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Docker Tag
        id: get-tag
        run: |
          TAG=$(grep 'flashinfer/flashinfer-ci-cu129:' ci/docker-tags.yml | cut -d':' -f2 | tr -d ' ')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Docker tag: $TAG"

      - name: Check Skip Conditions
        id: check
        run: |
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          # TODO (yongwww): Add back ^\.github/ before merging to main
          SKIP_PATTERNS="README.md|^docs/|^docker/|^licenses/|^LICENSE$|^NOTICE$|^version\.txt$"

          SKIP=true
          while IFS= read -r file; do
            if [ -n "$file" ] && ! echo "$file" | grep -qE "$SKIP_PATTERNS"; then
              SKIP=false
              break
            fi
          done <<< "$CHANGED"

          echo "skip=$SKIP" >> $GITHUB_OUTPUT
          [ "$SKIP" == "true" ] && echo "::notice::Skipping build - only docs/config files changed"

  # ---------------------------------------------------------------------------
  # AOT Build Tests - x86_64 and aarch64 (multiple CUDA versions)
  # ---------------------------------------------------------------------------
  aot-build-import:
    name: AOT Build (${{ matrix.arch }}, ${{ matrix.cuda }})
    needs: setup
    if: needs.setup.outputs.skip_build != 'true' && github.event.inputs.skip_aot != 'true'
    runs-on:
      - self-hosted
      - Linux
      - ${{ matrix.arch }}
      - cpu
    timeout-minutes: 300
    strategy:
      fail-fast: true
      matrix:
        arch: [X64, ARM64]
        cuda: [cu126, cu128, cu129, cu130]
    container:
      image: flashinfer/flashinfer-ci-${{ matrix.cuda }}:${{ needs.setup.outputs.docker_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show System Info
        run: |
          echo "=== System ===" && df -h && free -h && nproc && lscpu | head -15

      - name: Show Node Info
        run: ./scripts/task_show_node_info.sh
        env:
          NODE_NAME: ${{ runner.name }}
          WORKSPACE: ${{ github.workspace }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Test JIT Cache Package Build and Import
        run: ./scripts/task_test_jit_cache_package_build_import.sh

      - name: Cleanup
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/* ~/.cache/flashinfer_jit || true

  # ---------------------------------------------------------------------------
  # GPU JIT Tests - SM86 (A10G) - 5 Shards
  # ---------------------------------------------------------------------------
  gpu-tests-a10g:
    name: JIT Unittest ${{ matrix.shard }} (A10G)
    needs: setup
    if: needs.setup.outputs.skip_build != 'true' && github.event.inputs.skip_gpu != 'true'
    runs-on: [self-hosted, Linux, X64, gpu, sm86]
    timeout-minutes: 300
    strategy:
      fail-fast: true
      matrix:
        shard: [1, 2, 3, 4, 5]
    container:
      image: flashinfer/flashinfer-ci-cu129:${{ needs.setup.outputs.docker_tag }}
      options: --gpus all --shm-size=16g
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show System Info
        run: |
          echo "=== System ===" && df -h && free -h && nproc
          echo "=== GPU ===" && nvidia-smi && nvcc --version || true

      - name: Show Node Info
        run: ./scripts/task_show_node_info.sh
        env:
          NODE_NAME: ${{ runner.name }}
          WORKSPACE: ${{ github.workspace }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Run JIT Unittest Part ${{ matrix.shard }}
        run: ./scripts/task_jit_run_tests_part${{ matrix.shard }}.sh

      - name: Cleanup
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/* ~/.cache/flashinfer_jit || true

  # ---------------------------------------------------------------------------
  # GPU JIT Tests - SM75 (T4) - sampling tests only
  # ---------------------------------------------------------------------------
  gpu-tests-t4:
    name: JIT Unittest G4 (T4)
    needs: setup
    if: needs.setup.outputs.skip_build != 'true' && github.event.inputs.skip_gpu != 'true'
    runs-on: [self-hosted, Linux, X64, gpu, sm75]
    timeout-minutes: 300
    container:
      image: flashinfer/flashinfer-ci-cu129:${{ needs.setup.outputs.docker_tag }}
      options: --gpus all --shm-size=16g
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show System Info
        run: |
          echo "=== System ===" && df -h && free -h && nproc
          echo "=== GPU ===" && nvidia-smi && nvcc --version || true

      - name: Show Node Info
        run: ./scripts/task_show_node_info.sh
        env:
          NODE_NAME: ${{ runner.name }}
          WORKSPACE: ${{ github.workspace }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Run JIT Unittest Part 3 (T4)
        run: ./scripts/task_jit_run_tests_part3.sh

      - name: Cleanup
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/* ~/.cache/flashinfer_jit || true

  # ---------------------------------------------------------------------------
  # CI Summary
  # ---------------------------------------------------------------------------
  ci-summary:
    name: CI Summary
    if: always()
    needs: [setup, aot-build-import, gpu-tests-a10g, gpu-tests-t4]
    runs-on: ubuntu-latest
    steps:
      - name: Check Results
        run: |
          echo "## CI Results Summary" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.setup.outputs.skip_build }}" == "true" ]; then
            echo "Build skipped (docs/config only changes)" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "AOT Build: ${{ needs.aot-build-import.result }}" >> $GITHUB_STEP_SUMMARY
          echo "GPU Tests (A10G): ${{ needs.gpu-tests-a10g.result }}" >> $GITHUB_STEP_SUMMARY
          echo "GPU Tests (T4): ${{ needs.gpu-tests-t4.result }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.aot-build-import.result }}" == "failure" ] || \
             [ "${{ needs.gpu-tests-a10g.result }}" == "failure" ] || \
             [ "${{ needs.gpu-tests-t4.result }}" == "failure" ]; then
            echo "**CI Failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "**CI Passed**" >> $GITHUB_STEP_SUMMARY
