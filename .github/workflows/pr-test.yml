# PR Test Gateway - Creates check runs and triggers test runner
#
# Creates custom check runs via GitHub App, then dispatches tests to
# pr-test-runner.yml. Failed spot attempts are hidden from PR status.

name: PR Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:
    inputs:
      skip_aot:
        description: 'Skip AOT build tests'
        type: boolean
        default: false
      skip_gpu:
        description: 'Skip GPU tests'
        type: boolean
        default: false

concurrency:
  group: pr-test-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: write

env:
  EXECUTOR_NUMBER: "0"

jobs:
  gate:
    name: Permission Check
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
    steps:
      - name: Check authorization
        id: check
        env:
          GH_TOKEN: ${{ secrets.FLASHINFER_GITHUB_TOKEN }}
        run: |
          # Always allow push to main and workflow_dispatch
          if [[ "${{ github.event_name }}" != "pull_request" ]]; then
            echo "authorized=true" >> "$GITHUB_OUTPUT"
            echo "Not a PR, authorized"
            exit 0
          fi

          # Check if PR has run-ci label
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'run-ci') }}" == "true" ]]; then
            echo "authorized=true" >> "$GITHUB_OUTPUT"
            echo "PR has run-ci label, authorized"
            exit 0
          fi

          # Check if PR author is a member of ci-users team
          AUTHOR="${{ github.event.pull_request.user.login }}"
          ORG="${{ github.repository_owner }}"
          TEAM="ci-users"

          echo "Checking if $AUTHOR is a member of $ORG/$TEAM..."

          if [[ -z "$GH_TOKEN" ]]; then
            echo "::warning::FLASHINFER_GITHUB_TOKEN not set, falling back to association check"
            # Fallback: check if author has write access
            ASSOC="${{ github.event.pull_request.author_association }}"
            if [[ "$ASSOC" =~ ^(OWNER|MEMBER|COLLABORATOR)$ ]]; then
              echo "authorized=true" >> "$GITHUB_OUTPUT"
              echo "PR author has $ASSOC access, authorized"
            else
              echo "authorized=false" >> "$GITHUB_OUTPUT"
              echo "PR author is $ASSOC, not authorized"
            fi
            exit 0
          fi

          # Check team membership
          MEMBERS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            --paginate \
            "/orgs/${ORG}/teams/${TEAM}/members" \
            --jq '.[].login' 2>&1) || {
            echo "::warning::Failed to get team members: $MEMBERS"
            echo "authorized=false" >> "$GITHUB_OUTPUT"
            exit 0
          }

          if echo "$MEMBERS" | grep -qx "$AUTHOR"; then
            echo "authorized=true" >> "$GITHUB_OUTPUT"
            echo "$AUTHOR is a member of $TEAM, authorized"
          else
            echo "authorized=false" >> "$GITHUB_OUTPUT"
            echo "$AUTHOR is not a member of $TEAM, not authorized"
          fi

  setup:
    name: Setup
    needs: gate
    if: needs.gate.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.get-tag.outputs.tag }}
      skip_build: ${{ steps.check.outputs.skip }}
      head_sha: ${{ steps.get-sha.outputs.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get HEAD SHA
        id: get-sha
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Get Docker Tag
        id: get-tag
        run: |
          TAG=$(grep 'flashinfer/flashinfer-ci-cu129:' ci/docker-tags.yml | cut -d':' -f2 | tr -d ' ')
          if [ -z "$TAG" ]; then
            echo "::error::Failed to extract Docker tag from ci/docker-tags.yml"
            exit 1
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Docker tag: $TAG"

      - name: Check Skip Conditions
        id: check
        run: |
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Use PR event SHAs for reliable diff (avoids issues with origin refs)
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          CHANGED=$(git diff --name-only "$BASE_SHA...$HEAD_SHA")
          # TODO (yongwww): Add back ^\.github/ before merging to main
          SKIP_PATTERNS="README.md|^docs/|^docker/|^licenses/|^LICENSE$|^NOTICE$|^version\.txt$"

          SKIP=true
          while IFS= read -r file; do
            if [ -n "$file" ] && ! echo "$file" | grep -qE "$SKIP_PATTERNS"; then
              SKIP=false
              break
            fi
          done <<< "$CHANGED"

          echo "skip=$SKIP" >> $GITHUB_OUTPUT
          if [ "$SKIP" == "true" ]; then
            echo "::notice::Skipping build - only docs/config files changed"
          fi

  orchestrator:
    name: Orchestrate Tests
    needs: [gate, setup]
    if: |
      needs.gate.outputs.authorized == 'true' &&
      needs.setup.outputs.skip_build != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate Token (flashinfer)
        id: flashinfer-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_KEY }}
          owner: flashinfer-ai
          repositories: flashinfer

      - name: Generate Token (ci-infra)
        id: ci-infra-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_KEY }}
          owner: flashinfer-ai
          repositories: ci-infra

      - name: Create Check Runs (PR only)
        id: create-checks
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ steps.flashinfer-token.outputs.token }}
        run: |
          SHA="${{ needs.setup.outputs.head_sha }}"
          REPO="${{ github.repository }}"
          RUNNER_URL="https://github.com/flashinfer-ai/ci-infra/actions/workflows/pr-test-runner.yml"

          if [ "${{ github.event.inputs.skip_aot }}" != "true" ]; then
            AOT_CHECK=$(gh api repos/$REPO/check-runs \
              -f name="AOT Build Tests" \
              -f head_sha="$SHA" \
              -f status="in_progress" \
              -F output[title]="In progress" \
              -F output[summary]="Running AOT build tests: [view test runs]($RUNNER_URL)" \
              --jq '.id')
            echo "aot_check_id=$AOT_CHECK" >> $GITHUB_OUTPUT
          fi

          if [ "${{ github.event.inputs.skip_gpu }}" != "true" ]; then
            A10G_CHECK=$(gh api repos/$REPO/check-runs \
              -f name="JIT Unittest (A10G)" \
              -f head_sha="$SHA" \
              -f status="in_progress" \
              -F output[title]="In progress" \
              -F output[summary]="Running JIT unittests on A10G instances: [view test runs]($RUNNER_URL)" \
              --jq '.id')
            echo "gpu_a10g_check_id=$A10G_CHECK" >> $GITHUB_OUTPUT

            T4_CHECK=$(gh api repos/$REPO/check-runs \
              -f name="JIT Unittest (T4)" \
              -f head_sha="$SHA" \
              -f status="in_progress" \
              -F output[title]="In progress" \
              -F output[summary]="Running JIT unittests on T4 instances: [view test runs]($RUNNER_URL)" \
              --jq '.id')
            echo "gpu_t4_check_id=$T4_CHECK" >> $GITHUB_OUTPUT
          fi

          SUMMARY_CHECK=$(gh api repos/$REPO/check-runs \
            -f name="Test Results Summary" \
            -f head_sha="$SHA" \
            -f status="in_progress" \
            -F output[title]="In progress" \
            -F output[summary]="Waiting for test results: [view test runs]($RUNNER_URL)" \
            --jq '.id')
          echo "summary_check_id=$SUMMARY_CHECK" >> $GITHUB_OUTPUT

      - name: Trigger Test Runner
        env:
          GH_TOKEN: ${{ steps.ci-infra-token.outputs.token }}
        run: |
          gh api repos/flashinfer-ai/ci-infra/dispatches \
            -f event_type="run-pr-test" \
            -f client_payload[pr_head_sha]="${{ needs.setup.outputs.head_sha }}" \
            -f client_payload[docker_tag]="${{ needs.setup.outputs.docker_tag }}" \
            -f client_payload[aot_check_id]="${{ steps.create-checks.outputs.aot_check_id || '' }}" \
            -f client_payload[gpu_a10g_check_id]="${{ steps.create-checks.outputs.gpu_a10g_check_id || '' }}" \
            -f client_payload[gpu_t4_check_id]="${{ steps.create-checks.outputs.gpu_t4_check_id || '' }}" \
            -f client_payload[summary_check_id]="${{ steps.create-checks.outputs.summary_check_id || '' }}" \
            -f client_payload[skip_aot]="${{ github.event.inputs.skip_aot || 'false' }}" \
            -f client_payload[skip_gpu]="${{ github.event.inputs.skip_gpu || 'false' }}" \
            -f client_payload[concurrency_key]="pr-test-${{ github.ref }}"

  report-unauthorized:
    name: Report Unauthorized
    needs: gate
    if: github.event_name == 'pull_request' && needs.gate.outputs.authorized != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Post Comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "## CI Authorization Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This PR requires authorization to run CI." >> $GITHUB_STEP_SUMMARY
          echo "A member of @flashinfer-ai/ci-users can comment \`@flashinfer-bot run\` to approve." >> $GITHUB_STEP_SUMMARY
