# FlashInfer CI
# Main continuous integration workflow using AWS self-hosted runners.
# Runs AOT build tests and GPU unit tests on every push/PR.
#
# - Spot retry: Handled by aws infrastructure
# - Test scripts: Reuses existing task_*.sh scripts
# - Docker tag: Reads from ci/docker-tags.yml (single source of truth)

name: PR Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_aot:
        description: 'Skip AOT build tests'
        required: false
        type: boolean
        default: false
      skip_gpu:
        description: 'Skip GPU tests'
        required: false
        type: boolean
        default: false

# Cancel previous runs for the same branch/PR
concurrency:
  group: pr-test-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ===========================================================================
  # Setup - Read docker tag from ci/docker-tags.yml
  # ===========================================================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.get-tag.outputs.tag }}
      skip_build: ${{ steps.check.outputs.skip }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Docker Tag
        id: get-tag
        run: |
          # Read tag from ci/docker-tags.yml (all images use the same tag)
          TAG=$(grep 'flashinfer/flashinfer-ci-cu129:' ci/docker-tags.yml | cut -d':' -f2 | tr -d ' ')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Docker tag: $TAG"

      - name: Check if only docs/config changed
        id: check
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Get changed files
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

            # Skip patterns (same as Jenkins)
            # TODO (yongwww): Add back ^\.github/ before merging to main
            SKIP_PATTERNS="README.md|^docs/|^docker/|^licenses/|^LICENSE$|^NOTICE$|^version\.txt$"

            # Check if all changes match skip patterns
            SKIP=true
            while IFS= read -r file; do
              if [ -n "$file" ] && ! echo "$file" | grep -qE "$SKIP_PATTERNS"; then
                SKIP=false
                break
              fi
            done <<< "$CHANGED"

            echo "skip=$SKIP" >> $GITHUB_OUTPUT
            if [ "$SKIP" == "true" ]; then
              echo "::notice::Skipping build - only docs/config files changed"
            fi
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

  # ===========================================================================
  # AOT Build Tests - x86_64 (4 CUDA versions)
  # ===========================================================================
  aot-build-x64:
    name: AOT Build (x64, ${{ matrix.cuda }})
    needs: setup
    if: |
      needs.setup.outputs.skip_build != 'true' &&
      (github.event.inputs.skip_aot != 'true' || github.event.inputs.skip_aot == '')
    runs-on: [self-hosted, Linux, X64, cpu]
    timeout-minutes: 240
    strategy:
      fail-fast: true
      matrix:
        cuda: [cu126, cu128, cu129, cu130]
    container:
      image: flashinfer/flashinfer-ci-${{ matrix.cuda }}:${{ needs.setup.outputs.docker_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show Work Directory
        run: ls -alh

      - name: Show System Info
        run: |
          echo "=== Disk Space ==="
          df -h
          echo ""
          echo "=== Memory ==="
          free -h
          echo ""
          echo "=== CPU ==="
          nproc
          lscpu | head -20

      - name: Show Node Info
        run: ./scripts/task_show_node_info.sh
        env:
          NODE_NAME: ${{ runner.name }}
          EXECUTOR_NUMBER: "0"
          WORKSPACE: ${{ github.workspace }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Test JIT Cache Package Build and Import
        run: ./scripts/task_test_jit_cache_package_build_import.sh

      - name: Cleanup
        if: always()
        run: |
          # Clean up workspace and caches to save disk space
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf ~/.cache/flashinfer_jit || true

  # ===========================================================================
  # AOT Build Tests - aarch64 (4 CUDA versions)
  # Replaces: AOT-Build-Import-aarch64-cu{126,128,129,130}
  # ===========================================================================
  aot-build-arm64:
    name: AOT Build (arm64, ${{ matrix.cuda }})
    needs: setup
    if: |
      needs.setup.outputs.skip_build != 'true' &&
      (github.event.inputs.skip_aot != 'true' || github.event.inputs.skip_aot == '')
    runs-on: [self-hosted, Linux, ARM64, cpu]
    timeout-minutes: 240
    strategy:
      fail-fast: true
      matrix:
        cuda: [cu126, cu128, cu129, cu130]
    container:
      image: flashinfer/flashinfer-ci-${{ matrix.cuda }}:${{ needs.setup.outputs.docker_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show Work Directory
        run: ls -alh

      - name: Show System Info
        run: |
          echo "=== Disk Space ==="
          df -h
          echo ""
          echo "=== Memory ==="
          free -h
          echo ""
          echo "=== CPU ==="
          nproc
          lscpu | head -20

      - name: Show Node Info
        run: ./scripts/task_show_node_info.sh
        env:
          NODE_NAME: ${{ runner.name }}
          EXECUTOR_NUMBER: "0"
          WORKSPACE: ${{ github.workspace }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Test JIT Cache Package Build and Import
        run: ./scripts/task_test_jit_cache_package_build_import.sh

      - name: Cleanup
        if: always()
        run: |
          # Clean up workspace and caches to save disk space
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf ~/.cache/flashinfer_jit || true

  # ===========================================================================
  # GPU JIT Tests - SM86 (A10G) - 5 Shards
  # Replaces: JIT-Unittest-{1,2,3,4,5}-cu129
  # ===========================================================================
  gpu-tests-sm86:
    name: JIT Unittest ${{ matrix.shard }} (SM86/A10G)
    needs: setup
    if: |
      needs.setup.outputs.skip_build != 'true' &&
      (github.event.inputs.skip_gpu != 'true' || github.event.inputs.skip_gpu == '')
    runs-on: [self-hosted, Linux, X64, gpu, sm86]
    timeout-minutes: 120
    strategy:
      fail-fast: true
      matrix:
        shard: [1, 2, 3, 4, 5]
    container:
      image: flashinfer/flashinfer-ci-cu129:${{ needs.setup.outputs.docker_tag }}
      options: --gpus all --shm-size=16g
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show Work Directory
        run: ls -alh

      - name: Show System Info
        run: |
          echo "=== Disk Space ==="
          df -h
          echo ""
          echo "=== Memory ==="
          free -h
          echo ""
          echo "=== CPU ==="
          nproc
          lscpu | head -20
          echo ""
          echo "=== GPU ==="
          nvidia-smi
          echo ""
          echo "=== CUDA Version ==="
          nvcc --version || echo "nvcc not in PATH"

      - name: Show Node Info
        run: ./scripts/task_show_node_info.sh
        env:
          NODE_NAME: ${{ runner.name }}
          EXECUTOR_NUMBER: "0"
          WORKSPACE: ${{ github.workspace }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Run JIT Unittest Part ${{ matrix.shard }}
        run: ./scripts/task_jit_run_tests_part${{ matrix.shard }}.sh

      - name: Cleanup
        if: always()
        run: |
          # Clean up workspace and caches to save disk space
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf ~/.cache/flashinfer_jit || true

  # ===========================================================================
  # GPU JIT Tests - SM75 (T4) - Part 3 Only
  # Replaces: JIT-Unittest-G4-cu129
  # Note: T4 only runs Part 3 (sampling tests) due to memory constraints
  # ===========================================================================
  gpu-tests-sm75:
    name: JIT Unittest G4 (SM75/T4)
    needs: setup
    if: |
      needs.setup.outputs.skip_build != 'true' &&
      (github.event.inputs.skip_gpu != 'true' || github.event.inputs.skip_gpu == '')
    runs-on: [self-hosted, Linux, X64, gpu, sm75]
    timeout-minutes: 90
    container:
      image: flashinfer/flashinfer-ci-cu129:${{ needs.setup.outputs.docker_tag }}
      options: --gpus all --shm-size=16g
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show Work Directory
        run: ls -alh

      - name: Show System Info
        run: |
          echo "=== Disk Space ==="
          df -h
          echo ""
          echo "=== Memory ==="
          free -h
          echo ""
          echo "=== CPU ==="
          nproc
          lscpu | head -20
          echo ""
          echo "=== GPU ==="
          nvidia-smi
          echo ""
          echo "=== CUDA Version ==="
          nvcc --version || echo "nvcc not in PATH"

      - name: Show Node Info
        run: ./scripts/task_show_node_info.sh
        env:
          NODE_NAME: ${{ runner.name }}
          EXECUTOR_NUMBER: "0"
          WORKSPACE: ${{ github.workspace }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Run JIT Unittest Part 3 (SM75)
        run: ./scripts/task_jit_run_tests_part3.sh

      - name: Cleanup
        if: always()
        run: |
          # Clean up workspace and caches to save disk space
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf ~/.cache/flashinfer_jit || true

  # ===========================================================================
  # CI Summary - Reports overall status
  # ===========================================================================
  ci-summary:
    name: CI Summary
    if: always()
    needs: [setup, aot-build-x64, aot-build-arm64, gpu-tests-sm86, gpu-tests-sm75]
    runs-on: ubuntu-latest
    steps:
      - name: Check Results
        run: |
          echo "## CI Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check skip
          if [ "${{ needs.setup.outputs.skip_build }}" == "true" ]; then
            echo "Build skipped (docs/config only changes)" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Check AOT builds
          echo "### AOT Build Tests" >> $GITHUB_STEP_SUMMARY
          echo "- x64: ${{ needs.aot-build-x64.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: ${{ needs.aot-build-arm64.result }}" >> $GITHUB_STEP_SUMMARY

          # Check GPU tests
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GPU Tests" >> $GITHUB_STEP_SUMMARY
          echo "- SM86 (A10G): ${{ needs.gpu-tests-sm86.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- SM75 (T4): ${{ needs.gpu-tests-sm75.result }}" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [ "${{ needs.aot-build-x64.result }}" == "failure" ] || \
             [ "${{ needs.aot-build-arm64.result }}" == "failure" ] || \
             [ "${{ needs.gpu-tests-sm86.result }}" == "failure" ] || \
             [ "${{ needs.gpu-tests-sm75.result }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**CI Failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CI Passed**" >> $GITHUB_STEP_SUMMARY
