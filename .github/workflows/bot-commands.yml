# FlashInfer Bot Commands
# Handles slash commands in PR comments for CI control
#
# Available commands (for authorized users):
#   /run-ci         - Trigger full CI run
#   /run-gpu-tests  - Trigger GPU tests only
#   /run-aot-tests  - Trigger AOT build tests only
#   /rerun-failed   - Rerun failed jobs
#   /help           - Show available commands
#
# To add authorized users, edit the AUTHORIZED_USERS list below.

name: Bot Commands

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: write

env:
  # Authorized users who can trigger CI via bot commands
  # Add GitHub usernames here (one per line for readability)
  AUTHORIZED_USERS: |
    yongwww

jobs:
  # ===========================================================================
  # /run-ci - Trigger full CI
  # ===========================================================================
  run-ci:
    name: Run Full CI
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/run-ci') &&
      contains(fromJson('["yongwww"]'), github.event.comment.user.login)
    runs-on: ubuntu-latest
    steps:
      - name: Add reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);

      - name: Trigger CI workflow
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'pr-test.yml',
              ref: '${{ steps.pr.outputs.ref }}'
            });

      - name: Comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `CI triggered by @${{ github.event.comment.user.login }}\n\nWorkflow: [PR Test](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/workflows/pr-test.yml)`
            });

  # ===========================================================================
  # /run-gpu-tests - Trigger GPU tests only
  # ===========================================================================
  run-gpu-tests:
    name: Run GPU Tests
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/run-gpu-tests') &&
      contains(fromJson('["yongwww"]'), github.event.comment.user.login)
    runs-on: ubuntu-latest
    steps:
      - name: Add reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);

      - name: Trigger CI workflow (GPU only)
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'pr-test.yml',
              ref: '${{ steps.pr.outputs.ref }}',
              inputs: {
                skip_aot: 'true',
                skip_gpu: 'false'
              }
            });

      - name: Comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `GPU tests triggered by @${{ github.event.comment.user.login }}\n\nWorkflow: [PR Test](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/workflows/pr-test.yml)`
            });

  # ===========================================================================
  # /run-aot-tests - Trigger AOT build tests only
  # ===========================================================================
  run-aot-tests:
    name: Run AOT Tests
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/run-aot-tests') &&
      contains(fromJson('["yongwww"]'), github.event.comment.user.login)
    runs-on: ubuntu-latest
    steps:
      - name: Add reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);

      - name: Trigger CI workflow (AOT only)
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'pr-test.yml',
              ref: '${{ steps.pr.outputs.ref }}',
              inputs: {
                skip_aot: 'false',
                skip_gpu: 'true'
              }
            });

      - name: Comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `AOT build tests triggered by @${{ github.event.comment.user.login }}\n\nWorkflow: [PR Test](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/workflows/pr-test.yml)`
            });

  # ===========================================================================
  # /rerun-failed - Rerun failed jobs
  # ===========================================================================
  rerun-failed:
    name: Rerun Failed
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/rerun-failed') &&
      contains(fromJson('["yongwww"]'), github.event.comment.user.login)
    runs-on: ubuntu-latest
    steps:
      - name: Add reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('sha', pr.data.head.sha);

      - name: Rerun failed jobs
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: '${{ steps.pr.outputs.sha }}',
              status: 'failure'
            });

            if (runs.data.workflow_runs.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `No failed workflow runs found for this PR.`
              });
              return;
            }

            const failedRun = runs.data.workflow_runs[0];
            await github.rest.actions.reRunWorkflowFailedJobs({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: failedRun.id
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `Rerunning failed jobs by @${{ github.event.comment.user.login }}\n\nWorkflow run: [${failedRun.name}](${failedRun.html_url})`
            });

  # ===========================================================================
  # /help - Show available commands (anyone can use)
  # ===========================================================================
  help:
    name: Show Help
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/help')
    runs-on: ubuntu-latest
    steps:
      - name: Add reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '+1'
            });

      - name: Comment help
        uses: actions/github-script@v7
        with:
          script: |
            const authorizedUsers = ["yongwww"];
            const isAuthorized = authorizedUsers.includes(context.payload.comment.user.login);
            const status = isAuthorized ? 'You are authorized' : 'You are not authorized';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## FlashInfer CI Bot Commands\n\n${status}\n\n### Available Commands\n\n| Command | Description | Authorization Required |\n|---------|-------------|------------------------|\n| \`/run-ci\` | Trigger full CI run | Yes |\n| \`/run-gpu-tests\` | Trigger GPU tests only | Yes |\n| \`/run-aot-tests\` | Trigger AOT build tests only | Yes |\n| \`/rerun-failed\` | Rerun failed jobs | Yes |\n| \`/help\` | Show this help message | No |\n\n### Getting Access\n\nTo request CI access, please contact a maintainer.`
            });

  # ===========================================================================
  # Unauthorized command
  # ===========================================================================
  unauthorized:
    name: Unauthorized
    if: |
      github.event.issue.pull_request &&
      (startsWith(github.event.comment.body, '/run-ci') ||
       startsWith(github.event.comment.body, '/run-gpu-tests') ||
       startsWith(github.event.comment.body, '/run-aot-tests') ||
       startsWith(github.event.comment.body, '/rerun-failed')) &&
      !contains(fromJson('["yongwww"]'), github.event.comment.user.login)
    runs-on: ubuntu-latest
    steps:
      - name: Add reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'confused'
            });

      - name: Comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `@${{ github.event.comment.user.login }} You are not authorized to use this command.\n\nTo request access, please contact a maintainer.`
            });
